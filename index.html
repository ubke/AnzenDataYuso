<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Memo Transfer</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        /* LINE風 UIデザイン */
        :root {
            --bg-color: #7289DA; /* ディスコードとLINEの中間のような色 */
            --chat-bg: #85a0e6;
            --msg-bg-me: #8de055;
            --text-color: #333;
        }
        body { margin: 0; font-family: sans-serif; background-color: var(--chat-bg); height: 100vh; display: flex; flex-direction: column; }
        
        /* ヘッダー */
        header { background-color: #5d72a8; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 18px; }
        
        /* チャットエリア */
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .message { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 16px; line-height: 1.4; position: relative; word-break: break-all; }
        .message.self { align-self: flex-end; background-color: var(--msg-bg-me); color: var(--text-color); border-bottom-right-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .message img { max-width: 100%; border-radius: 10px; display: block; margin-top: 5px; cursor: pointer; }
        
        /* 入力エリア */
        #input-area { background: white; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        #message-input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; font-size: 16px; }
        #file-btn, #send-btn { background: none; border: none; cursor: pointer; color: #5d72a8; }
        #file-input { display: none; }

        /* 認証・設定モーダル */
        #auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 350px; text-align: center; }
        .modal-content input { width: 100%; padding: 10px; margin: 10px 0; box-sizing: border-box; }
        .modal-content button { width: 100%; padding: 12px; background: #5d72a8; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .hidden { display: none !important; }

        /* 画像グリッドのスタイル */
        .image-grid {
            display: grid;
            gap: 2px;
            border-radius: 12px;
            overflow: hidden;
            width: 100%;
            max-width: 300px; /* バカでかくならないように制限 */
        }
        
        /* 枚数ごとのレイアウト定義 */
        .image-grid[data-count="1"] { grid-template-columns: 1fr; }
        .image-grid[data-count="2"] { grid-template-columns: 1fr 1fr; }
        .image-grid[data-count="3"] { grid-template-columns: 1fr 1fr 1fr; }
        .image-grid[data-count="4"] { grid-template-columns: 1fr 1fr; } /* 2x2 */
        
        /* 5枚以上は3列 */
        .image-grid[data-count="5"], .image-grid[data-count="6"], 
        .image-grid[data-count="7"], .image-grid[data-count="8"], 
        .image-grid[data-count="9"] { 
            grid-template-columns: repeat(3, 1fr); 
        }

        .image-grid img, .image-grid video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            aspect-ratio: 1 / 1; /* 正方形にする */
            display: block;
        }
        
        /* 1枚だけの時は正方形強制を解除 */
        .image-grid[data-count="1"] img, .image-grid[data-count="1"] video {
            aspect-ratio: auto;
            max-height: 400px;
        }
        
    </style>
</head>
<body>

    <div id="auth-modal">
        <div class="modal-content">
            <h2>セキュリティ設定</h2>
            <p>このパスワードが暗号化キーになります。<br>忘れるとデータは復元できません。</p>
            <input type="email" id="email" placeholder="メールアドレス（ID代わり）">
            <input type="password" id="password" placeholder="ログインパスワード">
            <input type="password" id="encryption-key" placeholder="データ暗号化キー（必須）">
            <button onclick="login()">ログイン / 新規登録して開始</button>
        </div>
    </div>

    <header>
        <h1>anzen datA YUSO</h1>
        <button onclick="logout()" style="background: transparent; border: 1px solid white; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 14px;">
            ログアウト
        </button>
    </header>

    <div id="chat-container">
        </div>

    <div id="input-area">
        <label for="file-input" id="file-btn">
            <span class="material-icons" style="font-size: 30px;">add_photo_alternate</span>
        </label>
        <input type="file" id="file-input" accept="image/*,video/*" multiple onchange="handleFileSelect(this)">
        
        <input type="text" id="message-input" placeholder="メモを入力..." onkeypress="handleKeyPress(event)">
        
        <button id="send-btn" onclick="sendMessage()">
            <span class="material-icons" style="font-size: 30px;">send</span>
        </button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <script>
        // 【重要】ここにFirebase設定を貼り付ける
        // Firebase Console -> Project Settings -> General -> Your apps -> Config
        const firebaseConfig = {
            apiKey: "AIzaSyAST5jRP6cftYUHCb5MAtHr_H7SSht8mwA",
            authDomain: "anzendatayuso.firebaseapp.com",
            projectId: "anzendatayuso",
            storageBucket: "anzendatayuso.firebasestorage.app",
            messagingSenderId: "438096878174",
            appId: "1:438096878174:web:0c1867708a48af90ceb2cf"
        };

        // Firebase初期化
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        let currentUser = null;
        let secretKey = ""; // ユーザーが入力した暗号化キー

        // --- 暗号化・復号化ロジック (AES) ---
        // サーバーにはこの関数を通した「意味不明な文字列」しか保存されません
        function encryptData(data) {
            return CryptoJS.AES.encrypt(data, secretKey).toString();
        }

        function decryptData(ciphertext) {
            try {
                const bytes = CryptoJS.AES.decrypt(ciphertext, secretKey);
                return bytes.toString(CryptoJS.enc.Utf8);
            } catch (e) {
                return null; // 復号失敗（キーが違うなど）
            }
        }

        // --- ログイン処理 ---
        function login() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const key = document.getElementById('encryption-key').value;

            if (!email || !pass || !key) {
                alert("全ての項目を入力してください");
                return;
            }

            // 【追加】ここで鍵をブラウザに保存してしまう
            localStorage.setItem('savedKey', key); 
            secretKey = key; 

            // まずログインを試みる
            auth.signInWithEmailAndPassword(email, pass)
                .then((userCredential) => {
                    initApp(userCredential.user);
                })
                .catch((error) => {
                    // エラー処理（前回と同じロジック）
                    const errorCode = error.code;
                    if (errorCode === 'auth/user-not-found' || 
                        errorCode === 'auth/invalid-login-credentials' || 
                        errorCode === 'auth/invalid-credential') {
                        
                        auth.createUserWithEmailAndPassword(email, pass)
                            .then((userCredential) => {
                                initApp(userCredential.user);
                            })
                            .catch((createError) => {
                                if (createError.code === 'auth/email-already-in-use') {
                                    alert("パスワードが間違っています。");
                                } else if (createError.code === 'auth/weak-password') {
                                    alert("パスワードは6文字以上にしてください。");
                                } else {
                                    alert("登録エラー: " + createError.message);
                                }
                            });
                    } else {
                        alert("ログインエラー: " + error.message);
                    }
                });
        }

        function initApp(user) {
            currentUser = user;
            document.getElementById('auth-modal').classList.add('hidden');
            loadMessages();
        }

        function logout() {
            // ログアウト時は保存した鍵も消去する
            localStorage.removeItem('savedKey');
            auth.signOut();
            location.reload();
        }

        // --- メッセージ送信（複数枚セット対応版） ---
        async function sendMessage(textInput = null, imagesInput = null) {
            // テキストボックスの値を取得（引数がなければ）
            const input = document.getElementById('message-input');
            const text = textInput !== null ? textInput : input.value;
            
            // 画像配列の準備
            let images = [];
            if (imagesInput) {
                // 配列ならそのまま、単体なら配列にする（互換性のため）
                images = Array.isArray(imagesInput) ? imagesInput : [imagesInput];
            }

            if (!text && images.length === 0) return;

            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.style.opacity = "0.5";

            try {
                // ペイロード作成（images配列を保存）
                const payload = {
                    text: text,
                    images: images, // ここに複数枚入る
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // 暗号化・分割保存ロジック（変更なし、そのまま利用）
                const encryptedContent = encryptData(JSON.stringify(payload));
                const BATCH_SIZE = 900000;
                const totalLength = encryptedContent.length;
                
                const docRef = db.collection('users').doc(currentUser.uid).collection('memos').doc();
                const batch = db.batch();

                if (totalLength <= BATCH_SIZE) {
                    batch.set(docRef, {
                        content: encryptedContent,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'simple'
                    });
                } else {
                    const chunks = [];
                    for (let i = 0; i < totalLength; i += BATCH_SIZE) {
                        chunks.push(encryptedContent.substring(i, i + BATCH_SIZE));
                    }
                    batch.set(docRef, {
                        type: 'composite',
                        count: chunks.length,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    chunks.forEach((chunk, index) => {
                        const chunkRef = docRef.collection('chunks').doc(index.toString().padStart(3, '0'));
                        batch.set(chunkRef, { data: chunk });
                    });
                }

                await batch.commit();
                input.value = ""; // テキストボックスをクリア

            } catch (e) {
                console.error(e);
                alert("送信エラー: " + e.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.style.opacity = "1";
            }
        }

        // 描画の競合を防ぐための「整理券番号」
        let latestRenderId = 0;
        
        // 過去ログ読み込み用の管理変数
        let oldestDoc = null;      // 現在表示されている一番古いメッセージ
        let isLoadingOld = false;  // 読み込み中かどうかのフラグ

        // --- メッセージ読み込み（最新10件＋無限スクロール対応版） ---
        function loadMessages() {
            const container = document.getElementById('chat-container');

            // ★スクロール検知イベントを追加
            container.addEventListener('scroll', async () => {
                // 画面の一番上（scrollTopが0）に来て、かつ読み込み中でなければ
                if (container.scrollTop === 0 && !isLoadingOld && oldestDoc) {
                    await loadOlderMessages();
                }
            });

            db.collection('users').doc(currentUser.uid).collection('memos')
                .orderBy('createdAt', 'asc')
                .limitToLast(10)  // 【変更】最初は10件だけにする（高速化）
                .onSnapshot(async (snapshot) => {
                    const changes = snapshot.docChanges();
                    
                    // 初回ロード時、一番古いドキュメントを記録しておく（ここから過去に遡るため）
                    if (!oldestDoc && snapshot.docs.length > 0) {
                        oldestDoc = snapshot.docs[0];
                    }

                    for (const change of changes) {
                        if (change.type === "added") {
                            const doc = change.doc;
                            const data = doc.data();

                            // すでに表示済みならスキップ
                            if (document.getElementById(doc.id)) continue;

                            let encryptedString = "";
                            try {
                                if (data.type === 'composite') {
                                    const chunksSnapshot = await doc.ref.collection('chunks').orderBy(firebase.firestore.FieldPath.documentId()).get();
                                    encryptedString = chunksSnapshot.docs.map(d => d.data().data).join('');
                                } else {
                                    encryptedString = data.content;
                                }

                                if (!encryptedString) continue;

                                const decryptedJSON = decryptData(encryptedString);
                                if (!decryptedJSON) continue;

                                const payload = JSON.parse(decryptedJSON);

                                // 通常のメッセージ表示（下に追加）
                                renderMessage(payload, doc.id);

                            } catch (e) {
                                console.log("読み込みエラー:", e);
                            }
                        }
                    }

                    // 最新を表示（初回のみ）
                    if (latestRenderId === 0) { // 簡易判定
                        setTimeout(() => {
                            container.scrollTop = container.scrollHeight;
                        }, 100);
                        latestRenderId = 1; 
                    } else {
                        // ユーザーが一番下にいる時だけ自動スクロール
                        if (container.scrollHeight - container.scrollTop - container.clientHeight < 200) {
                             container.scrollTop = container.scrollHeight;
                        }
                    }
                });
        }

        // --- 【新機能】過去のメッセージを読み込む関数 ---
        async function loadOlderMessages() {
            if (isLoadingOld || !oldestDoc) return;
            isLoadingOld = true;

            const container = document.getElementById('chat-container');
            
            // ロード前のスクロール位置と高さを覚えておく（ガクッとなるのを防ぐため）
            const previousHeight = container.scrollHeight;
            const previousTop = container.scrollTop;

            try {
                // oldestDoc よりも前のデータを10件取得
                const snapshot = await db.collection('users').doc(currentUser.uid).collection('memos')
                    .orderBy('createdAt', 'asc')
                    .endBefore(oldestDoc)
                    .limitToLast(10)
                    .get();

                if (!snapshot.empty) {
                    // 新しい「一番古いドキュメント」を更新
                    oldestDoc = snapshot.docs[0];

                    // 取得したデータをHTMLにして、上に追加していくための箱
                    const fragment = document.createDocumentFragment();

                    // 順番通りに処理
                    for (const doc of snapshot.docs) {
                        const data = doc.data();
                        let encryptedString = "";

                        if (data.type === 'composite') {
                            const chunksSnapshot = await doc.ref.collection('chunks').orderBy(firebase.firestore.FieldPath.documentId()).get();
                            encryptedString = chunksSnapshot.docs.map(d => d.data().data).join('');
                        } else {
                            encryptedString = data.content;
                        }

                        if (encryptedString) {
                            const decryptedJSON = decryptData(encryptedString);
                            if (decryptedJSON) {
                                const payload = JSON.parse(decryptedJSON);
                                // 要素を作成（表示はしない）
                                const div = createMessageElement(payload, doc.id);
                                fragment.appendChild(div);
                            }
                        }
                    }

                    // まとめて画面の一番上に挿入
                    container.insertBefore(fragment, container.firstChild);

                    // スクロール位置を調整（見た目が変わらないようにする）
                    const newHeight = container.scrollHeight;
                    container.scrollTop = newHeight - previousHeight;
                }
            } catch (e) {
                console.error("過去ログ読み込みエラー:", e);
            } finally {
                isLoadingOld = false;
            }
        }

        // --- 画面表示（共通：要素を作るだけの関数） ---
        function createMessageElement(payload, docId) {
            const div = document.createElement('div');
            div.className = 'message self';
            if (docId) div.id = docId;

            const images = payload.images || (payload.image ? [payload.image] : []);
            
            if (images.length > 0) {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'image-grid';
                gridDiv.setAttribute('data-count', images.length);
                images.forEach(src => {
                    const el = createMediaElement(src);
                    gridDiv.appendChild(el);
                });
                div.appendChild(gridDiv);
            }

            if (payload.text) {
                const textDiv = document.createElement('div');
                textDiv.innerText = payload.text;
                div.appendChild(textDiv);
            }
            return div;
        }

        // --- 画面表示（通常用：下に追加する） ---
        function renderMessage(payload, docId) {
            const container = document.getElementById('chat-container');
            const div = createMessageElement(payload, docId);
            container.appendChild(div);
        }

        // （共通部品）画像・動画タグを作る関数（クリック拡大対応版）
        function createMediaElement(src) {
            if (src.startsWith('data:video')) {
                const video = document.createElement('video');
                video.src = src;
                video.controls = true;
                // 動画はプレーヤーの機能で全画面にできるので、ここでの処理は不要
                return video;
            } else {
                const img = document.createElement('img');
                img.src = src;
                img.style.cursor = "pointer"; // クリックできることをカーソルで示す
                
                // 【追加】画像がクリックされたら拡大関数を呼ぶ
                img.onclick = function(e) {
                    // 親要素へのイベント伝播（バグの元）を防ぐ
                    e.stopPropagation(); 
                    openModal(src);
                };
                return img;
            }
        }

        // --- 追加：拡大表示の制御 ---
        function openModal(src) {
            const modal = document.getElementById('image-modal');
            const img = document.getElementById('modal-img');
            
            // 拡大用画像のsrcに、クリックした画像のデータをセット
            img.src = src;
            
            // 画面を表示（Flexboxで中央寄せ）
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('image-modal');
            // 画面を隠す
            modal.style.display = 'none';
        }

        // --- 自動ログイン監視機能 ---
        // ページを開いた時、以前のログイン状態が残っているかチェックします
        auth.onAuthStateChanged((user) => {
            if (user) {
                // ユーザーとしてのログイン記録は残っている。
                // 次に、暗号化キーがブラウザに残っているか確認。
                const savedKey = localStorage.getItem('savedKey');

                if (savedKey) {
                    // 両方揃っていれば、ログイン画面を見せずに開始！
                    secretKey = savedKey;
                    initApp(user);
                } else {
                    // キーだけ無い場合は（キャッシュクリア等）、ログイン画面で入力を待つ
                    // 何もしなくてOK（モーダルが出たままになる）
                }
            }
        });

        // --- ユーティリティ ---
        function handleKeyPress(e) {
            if (e.key === 'Enter') sendMessage();
        }

        // 画像・動画選択時の処理（セット送信版）
        async function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                const files = Array.from(input.files);
                
                // 読み込み中を表示
                alert(`${files.length}枚の画像を読み込んでいます...`);

                // 全てのファイルを読み込むまで待つ（Promise.all）
                const readPromises = files.map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.readAsDataURL(file);
                    });
                });

                // 全ての画像データが揃ったら、まとめて送信！
                const imagesData = await Promise.all(readPromises);
                
                // 第2引数に配列を渡す
                // ※このあとsendMessageも修正する必要があります！
                await sendMessage(null, imagesData); 
            }
            input.value = '';
        }

        function escapeHtml(str) {
            if(!str) return "";
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag]));
        }
    </script>

    <div id="image-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; cursor: pointer;" onclick="closeModal()">
        <img id="modal-img" style="max-width: 95%; max-height: 95%; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
    </div>
    
</body>
</html>
